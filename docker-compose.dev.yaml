name: mc

services:

    accesspanel:
        extends:
            file: docker-compose.yaml
            service: accesspanel
        build:
            context: .
            dockerfile: docker/accesspanel/Dockerfile
            target: build-dev
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.whoami.entrypoints=${TRAEFIK_ENTRYPOINT}"
            - "traefik.http.routers.whoami.tls=false"
            - "traefik.http.routers.whoami.rule=Host(`${EXTERNAL_DOMAIN_R}`) || Host(`${EXTERNAL_DOMAIN_P}`) || Host(`${EXTERNAL_DOMAIN_K}`)"
        volumes:
            - type: bind
              source: application
              target: /var/www/html

    database:
        extends:
            file: docker-compose.yaml
            service: database
        ports:
            - "${DEV_DATABASE_EXTERNAL_PORT}:3306"

    traefik:
        image: traefik:v3.3
        container_name: traefik
        command:
            - "--api.insecure=true"
            - "--api.dashboard=true"
            - "--log.level=DEBUG"
            - "--log.filepath=/var/log/traefik.log"
            - "--accesslog=true"
            - "--accesslog.filepath=/var/log/traefik-access.log"
            - "--providers.docker.network=mc_mc_net"
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"
            - "--entryPoints.web.address=:80"
        labels:
            - traefik.enable=true
            - traefik.http.routers.mydashboard.rule=Host(`${TRAEFIK_DASHBOARD_EXTERNAL_DOMAIN}`)
            - traefik.http.routers.mydashboard.service=api@internal
        ports:
            - "${TRAEFIK_HTTP_PORT}:80"
            - "${TRAEFIK_DASHBOARD_PORT}:8080"
        volumes:
            - "./local/traefik_letsencrypt:/letsencrypt"
            - "./local/traefik_logs:/var/log"
            - "/var/run/docker.sock:/var/run/docker.sock:ro"
        networks:
            - mc_net

#    minecraft-r:
#        extends:
#            file: docker-compose.yaml
#            service: minecraft-r
#
#    minecraft-p:
#        extends:
#            file: docker-compose.yaml
#            service: minecraft-p

    minecraft-k:
        extends:
            file: docker-compose.yaml
            service: minecraft-k

    phpmyadmin:
        image: phpmyadmin:latest
        container_name: phpmyadmin
        restart: unless-stopped
        links:
            - database
        environment:
            PMA_HOST: ${DATABASE_HOST}
            PMA_USER: root
            PMA_PASSWORD: ${DATABASE_ROOT_PASSWORD}
            UPLOAD_LIMIT: 2000M
            MEMORY_LIMIT: 4000M
        ports:
            - "${DEV_PHPMYADMIN_EXTERNAL_PORT}:80"
        networks:
            - mc_net

networks:
    mc_net:
